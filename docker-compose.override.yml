# Docker Compose Override for Development
# This file is automatically loaded by docker-compose when running in local environment
# It extends docker-compose.yml with development-specific configurations

services:
  # PostgreSQL - development configuration
  postgres:
    environment:
      POSTGRES_HOST_AUTH_METHOD: trust

  # Redis - development configuration
  redis:
    command: redis-server --appendonly yes --requirepass changeme

  # API Service - Development Mode with Hot Reload & Infisical
  api:
    build:
      context: .
      dockerfile: packages/api/Dockerfile
      target: development  # Use development stage from Dockerfile
    container_name: modular-features-api-dev
    environment:
      # Application Environment
      NODE_ENV: development
      PORT: 3000

      # Infisical Secrets Management (Development)
      USE_INFISICAL: "true"
      INFISICAL_SITE_URL: ${INFISICAL_SITE_URL}
      INFISICAL_CLIENT_ID: ${INFISICAL_CLIENT_ID}
      INFISICAL_CLIENT_SECRET: ${INFISICAL_CLIENT_SECRET}
      INFISICAL_PROJECT_ID: ${INFISICAL_PROJECT_ID}
      INFISICAL_ENVIRONMENT: ${INFISICAL_ENVIRONMENT:-dev}
      INFISICAL_CACHE_TTL: ${INFISICAL_CACHE_TTL:-300000}

      # Service Connection Configuration (Not secrets)
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: modular_features
      POSTGRES_USER: postgres

      REDIS_HOST: redis
      REDIS_PORT: 6379

      # Better Auth Configuration
      BETTER_AUTH_URL: http://localhost:3000/api/auth

      # Keycloak Configuration (Primary OAuth Provider)
      KEYCLOAK_URL: https://auth.azfirazka.com
      KEYCLOAK_REALM: azfirazka
      KEYCLOAK_ISSUER: https://auth.azfirazka.com/realms/azfirazka
      KEYCLOAK_CLIENT_ID: modular-features-api
      KEYCLOAK_REDIRECT_URI: http://localhost:3000/api/auth/oauth/keycloak/callback

      # JWT Configuration
      JWT_EXPIRES_IN: 24h
      JWT_ACCESS_TOKEN_EXPIRY: 3h
      JWT_REFRESH_TOKEN_EXPIRY: 7d

      # Feature Flags
      ENABLE_KEYCLOAK: "true"
      ENABLE_BETTER_AUTH: "true"
      ENABLE_EMAIL_PASSWORD_AUTH: "false"
      ENABLE_RS256_TOKENS: "true"

      # CORS Configuration
      CORS_ORIGIN: http://localhost:3000,http://localhost:5173
      CORS_CREDENTIALS: "true"

      # Logging
      LOG_LEVEL: debug
      LOG_FORMAT: json

      # Security Configuration
      BCRYPT_ROUNDS: "12"

      # Rate Limiting Configuration
      ENABLE_RATE_LIMITING: "true"
      RATE_LIMIT_WINDOW_MS: "900000"
      RATE_LIMIT_MAX_REQUESTS: "100"
      QUOTA_CHECK_INTERVAL_MS: "60000"

      # File Upload Configuration
      MAX_FILE_SIZE: "5242880"
      ALLOWED_FILE_TYPES: image/jpeg,image/png,image/gif,image/webp
      UPLOAD_DIR: ./uploads

      # Feature Flags
      ENABLE_AUDIT_LOGGING: "true"

      # Optional: Fallback secrets (only used if Infisical fails)
      # These should match values in Infisical for development environment
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      REDIS_PASSWORD: ${REDIS_PASSWORD}
      BETTER_AUTH_SECRET: ${BETTER_AUTH_SECRET}
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET}
      JWT_SECRET: ${JWT_SECRET}
      SESSION_SECRET: ${SESSION_SECRET}
      CSRF_SECRET: ${CSRF_SECRET}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD}
    volumes:
      # Mount source code for hot reload
      - ./packages/api/src:/app/packages/api/src:ro
      - ./packages/shared/src:/app/packages/shared/src:ro
      - ./packages/database/src:/app/packages/database/src:ro
      - ./packages/api/package.json:/app/packages/api/package.json:ro
      - ./packages/shared/package.json:/app/packages/shared/package.json:ro
      - ./packages/database/package.json:/app/packages/database/package.json:ro
      - ./packages/api/tsconfig.json:/app/packages/api/tsconfig.json:ro
      - ./tsconfig.json:/app/tsconfig.json:ro
    # Override restart policy for development (don't restart on errors while coding)
    restart: unless-stopped
    # Disable health check in development (it may fail during code changes)
    healthcheck:
      test: ['CMD', 'bun', '-e', "fetch('http://localhost:3000/').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))"]
      interval: 30s
      timeout: 5s
      retries: 2
      start_period: 60s
